# Health Check EA - MT5 健康检查专家顾问

## 📋 功能说明

这是一个 MT5 (MetaTrader 5) 专家顾问程序，每秒钟自动请求一次本地服务器的健康检查接口 `http://localhost:6699/health`，用于监控服务器运行状态。

## 🚀 安装步骤

### 1. 复制文件到 MT5

将 `HealthCheckEA.mq5` 文件复制到 MT5 的专家顾问目录：

```
C:\Users\你的用户名\AppData\Roaming\MetaQuotes\Terminal\你的MT5数据文件夹\MQL5\Experts\
```

或者通过 MT5 菜单：
- 文件 → 打开数据文件夹 → MQL5 → Experts → 粘贴文件

### 2. 编译 EA

1. 在 MT5 中打开 MetaEditor（按 F4 或 工具 → MetaQuotes 语言编辑器）
2. 在导航器中找到 `HealthCheckEA.mq5`
3. 右键点击 → 编译（或按 F7）
4. 检查编译输出，确保没有错误

### 3. 配置 WebRequest 权限（重要！）

**这是必须的步骤，否则 EA 无法发送 HTTP 请求！**

1. 在 MT5 中：**工具 → 选项 → 专家顾问**
2. 勾选 **"允许WebRequest"**
3. 在 **"允许的URL列表"** 中添加：
   ```
   http://localhost:6699
   ```
   或者更精确的：
   ```
   http://localhost:6699/health
   ```
4. 点击 **"确定"** 保存

### 4. 将 EA 添加到图表

1. 在 MT5 导航器中找到 **"专家顾问"** → **"HealthCheckEA"**
2. 将 EA 拖拽到任意图表上
3. 在弹出窗口中：
   - **"允许自动交易"** 必须勾选（虽然此EA不交易，但需要启用）
   - **"允许DLL导入"** 不需要
   - **"允许导入外部专家"** 不需要
4. 点击 **"确定"**

## ⚙️ 参数说明

EA 提供以下可配置参数：

- **ServerURL** (默认: `http://localhost:6699/health`)
  - 健康检查接口的完整URL
  
- **RequestInterval** (默认: 1 秒)
  - 请求间隔时间（秒）
  - 设置为 1 表示每秒请求一次

## 📊 运行状态

EA 运行后会在 MT5 的 **"专家"** 标签页中显示日志信息：

- ✅ 请求成功时会显示响应内容和状态码
- ❌ 请求失败时会显示错误代码和提示信息
- 📊 EA 停止时会显示统计信息（总请求数、成功数、失败数、成功率）

### 示例日志输出：

```
✅ Health Check EA 初始化成功
📡 服务器地址: http://localhost:6699/health
⏱️  请求间隔: 1 秒
🚀 EA 已启动，开始监控服务器状态...
✅ [2025.01.15 10:30:01] 请求成功
   响应状态码: 200
   响应内容: {"status":"OK","timestamp":"2025-01-15T10:30:01.000Z","service":"Keltner Webhook Server","version":"1.0.0"}
   ✓ 服务器状态: OK
```

## ⚠️ 常见问题

### 1. 错误代码 4060

**问题：** WebRequest 功能未启用

**解决：** 
- 工具 → 选项 → 专家顾问 → 勾选 "允许WebRequest"

### 2. 错误代码 4014

**问题：** URL 不在允许列表中

**解决：**
- 在允许的URL列表中添加 `http://localhost:6699`

### 3. 连接失败

**问题：** 服务器未运行或端口不正确

**解决：**
- 确保 Node.js 服务器正在运行（端口 6699）
- 检查服务器地址是否正确
- 可以在浏览器中访问 `http://localhost:6699/health` 测试

### 4. EA 不工作

**检查清单：**
- ✅ EA 已添加到图表
- ✅ "允许自动交易" 已勾选
- ✅ WebRequest 已启用
- ✅ URL 已添加到允许列表
- ✅ 服务器正在运行

## 🔧 技术说明

- **语言：** MQL5
- **平台：** MetaTrader 5
- **请求方式：** HTTP GET
- **请求频率：** 每秒 1 次（可配置）
- **超时时间：** 5 秒

## 📝 注意事项

1. 此 EA **不会进行任何交易操作**，仅用于监控服务器状态
2. 可以同时运行多个实例（不同图表）
3. 建议在测试环境中先验证功能
4. 如果服务器长时间无响应，EA 会记录失败次数，但不会停止运行

## 🛑 停止 EA

要停止 EA，只需从图表上删除它：
- 右键点击图表上的 EA 名称 → 删除

EA 停止时会自动显示统计信息。

