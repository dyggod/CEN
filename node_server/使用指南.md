# Keltner Webhook 服务使用指南

## 🚀 快速开始

### 1. 安装依赖

```bash
cd node_server
npm install
```

### 2. 配置邮箱

编辑 `server.js`，第 20 行左右：

```javascript
SMTP_PASSWORD: 'your-qq-auth-code-here'  // 改成你的QQ邮箱授权码
```

**获取QQ邮箱授权码：**
1. 登录 https://mail.qq.com
2. 设置 → 账户 → 开启SMTP服务
3. 生成授权码（16位）

### 3. 启动服务

**方式A：PM2后台运行（推荐）**
```bash
双击: PM2启动.bat
```

**方式B：普通启动**
```bash
双击: 快速启动.bat
```

### 4. 测试

访问：http://localhost:5000/health

或运行：`一键诊断.bat`

---

## ⚙️ 配置说明

### server.js 核心配置

```javascript
const CONFIG = {
    PORT: 5000,                        // 端口
    SCREENSHOT_MODE: 'window',         // 截图模式：window=窗口 / fullscreen=全屏
    CTRADER_WINDOW_TITLE: 'cTrader',  // cTrader窗口标题关键词
    SCREENSHOT_DELAY: 500,             // 截图延迟（毫秒）
};
```

**如果窗口标题不是"cTrader"：**
1. 运行 `一键诊断.bat` 查看实际窗口标题
2. 修改 `CTRADER_WINDOW_TITLE` 为实际标题关键词（如 'IC Markets'）

---

## 🤖 cBot 配置

### Webhook 设置

```
Enable Webhook = true                          // 启用Webhook
Webhook URL = http://localhost:5000/screenshot // 默认即可
Webhook Mode = ScreenshotAndEmail              // 截图并发邮件
```

### 权限

首次编译时会提示 `FullAccess` 权限，点击"允许"。

---

## 📡 API 端点

- `GET /health` - 健康检查
- `POST /screenshot` - 截图并发邮件
- `POST /notify` - 仅发邮件
- `POST /test` - 测试连接

---

## 🔧 PM2 管理

```bash
PM2启动.bat         # 启动服务
PM2停止.bat         # 停止服务
PM2重启.bat         # 重启服务
PM2查看状态.bat     # 查看状态
PM2查看日志.bat     # 查看日志
PM2设置开机启动.bat # 开机自启
```

详见：`PM2使用指南.md`

---

## 🐛 故障排除

### 截图失败

1. 运行 `一键诊断.bat` 查看窗口标题
2. 确保 cTrader 窗口未最小化
3. 修改 `CTRADER_WINDOW_TITLE` 配置

### 邮件发送失败

1. 检查授权码是否正确
2. 确认QQ邮箱已开启SMTP服务
3. 检查网络连接

---

## 📝 文件说明

**核心文件：**
- `server.js` - 主服务器
- `package.json` - 依赖配置
- `ecosystem.config.js` - PM2配置
- `capture-window.ps1` - 窗口截图脚本
- `list-windows.ps1` - 查找窗口脚本

**启动脚本：**
- `快速启动.bat` - 普通启动
- `PM2启动.bat` - PM2启动
- `一键诊断.bat` - 测试工具

**文档：**
- `README.md` - 详细文档
- `PM2使用指南.md` - PM2详细说明
- `使用指南.md` - 本文件

---

**版本：** 1.1.0  
**最后更新：** 2025-11-24

