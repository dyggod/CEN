# PM2 è¿›ç¨‹ç®¡ç†å®Œæ•´æŒ‡å—

## ğŸ¯ ä»€ä¹ˆæ˜¯ PM2ï¼Ÿ

PM2 æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ Node.js è¿›ç¨‹ç®¡ç†å™¨ï¼Œå¯ä»¥è®©ä½ çš„æœåŠ¡ï¼š
- âœ… åå°è¿è¡Œï¼ˆä¸éœ€è¦ç»ˆç«¯çª—å£ï¼‰
- âœ… è‡ªåŠ¨é‡å¯ï¼ˆå´©æºƒåè‡ªåŠ¨æ¢å¤ï¼‰
- âœ… å¼€æœºè‡ªå¯ï¼ˆç”µè„‘é‡å¯åè‡ªåŠ¨è¿è¡Œï¼‰
- âœ… æ—¥å¿—ç®¡ç†ï¼ˆè‡ªåŠ¨è®°å½•æ‰€æœ‰è¾“å‡ºï¼‰
- âœ… çŠ¶æ€ç›‘æ§ï¼ˆCPUã€å†…å­˜ä½¿ç”¨æƒ…å†µï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£… PM2

**æ–¹æ³• Aï¼šè‡ªåŠ¨å®‰è£…ï¼ˆæ¨èï¼‰**

ç›´æ¥åŒå‡» `pm2/PM2å¯åŠ¨.bat`ï¼Œé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨å®‰è£… PM2ã€‚

**æ–¹æ³• Bï¼šæ‰‹åŠ¨å®‰è£…**

```bash
npm install -g pm2
```

éªŒè¯å®‰è£…ï¼š

```bash
pm2 --version
# åº”è¯¥æ˜¾ç¤ºï¼š5.x.x
```

---

### 2. å¯åŠ¨æœåŠ¡

**åŒå‡»è¿è¡Œï¼š** `pm2/PM2å¯åŠ¨.bat`

æˆ–å‘½ä»¤è¡Œï¼š

```bash
cd node_server
npm run pm2:start
```

ä½ ä¼šçœ‹åˆ°ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ name             â”‚ mode    â”‚ â†º      â”‚ status   â”‚ cpu    â”‚ memory   â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0   â”‚ EA&CTrader-Webhook  â”‚ fork    â”‚ 0       â”‚ online   â”‚ 0%     â”‚ 30.5mb   â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âœ… **çŠ¶æ€ä¸º `online` è¡¨ç¤ºæœåŠ¡è¿è¡Œæ­£å¸¸ï¼**

---

### 3. å¸¸ç”¨æ“ä½œ

#### æŸ¥çœ‹çŠ¶æ€

**åŒå‡»è¿è¡Œï¼š** `PM2æŸ¥çœ‹çŠ¶æ€.bat`

æˆ–å‘½ä»¤è¡Œï¼š

```bash
pm2 status
# æˆ–
pm2 info EA&CTrader-Webhook
```

---

#### æŸ¥çœ‹æ—¥å¿—

**åŒå‡»è¿è¡Œï¼š** `PM2æŸ¥çœ‹æ—¥å¿—.bat`

æˆ–å‘½ä»¤è¡Œï¼š

```bash
pm2 logs EA&CTrader-Webhook

# ä»…çœ‹æœ€æ–° 50 è¡Œ
pm2 logs EA&CTrader-Webhook --lines 50

# æ¸…ç©ºæ—¥å¿—
pm2 flush
```

**æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š**
- è¾“å‡ºæ—¥å¿—ï¼š`node_server/logs/output.log`
- é”™è¯¯æ—¥å¿—ï¼š`node_server/logs/error.log`

---

#### é‡å¯æœåŠ¡

**åŒå‡»è¿è¡Œï¼š** `PM2é‡å¯.bat`

æˆ–å‘½ä»¤è¡Œï¼š

```bash
pm2 restart EA&CTrader-Webhook
```

**ä½•æ—¶éœ€è¦é‡å¯ï¼Ÿ**
- ä¿®æ”¹äº† `server.js` ä»£ç 
- ä¿®æ”¹äº†é…ç½®å‚æ•°
- æœåŠ¡å‡ºç°å¼‚å¸¸

---

#### åœæ­¢æœåŠ¡

**åŒå‡»è¿è¡Œï¼š** `PM2åœæ­¢.bat`

æˆ–å‘½ä»¤è¡Œï¼š

```bash
pm2 stop EA&CTrader-Webhook
```

âš ï¸ åœæ­¢åæœåŠ¡ä¸ä¼šè¿è¡Œï¼Œä¸ä¼šå“åº” Webhook è¯·æ±‚ã€‚

---

#### å®Œå…¨åˆ é™¤æœåŠ¡

**åŒå‡»è¿è¡Œï¼š** `PM2å®Œå…¨åˆ é™¤.bat`

æˆ–å‘½ä»¤è¡Œï¼š

```bash
pm2 delete EA&CTrader-Webhook
```

âš ï¸ åˆ é™¤åéœ€è¦é‡æ–°è¿è¡Œ `pm2/PM2å¯åŠ¨.bat` æ‰èƒ½ä½¿ç”¨ã€‚

---

### 4. è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨ï¼ˆæ¨èï¼‰

**åŒå‡»è¿è¡Œï¼š** `PM2è®¾ç½®å¼€æœºå¯åŠ¨.bat`ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

æˆ–å‘½ä»¤è¡Œï¼š

```bash
# é…ç½®å¼€æœºå¯åŠ¨
pm2 startup

# ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨
pm2 save
```

**éªŒè¯ï¼š**
1. é‡å¯ç”µè„‘
2. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:5000/health
3. å¦‚æœèƒ½çœ‹åˆ°å“åº”ï¼Œè¯´æ˜å¼€æœºå¯åŠ¨æˆåŠŸï¼

**å–æ¶ˆå¼€æœºå¯åŠ¨ï¼š**

```bash
pm2 unstartup
pm2 save
```

---

## ğŸ“Š é«˜çº§åŠŸèƒ½

### å®æ—¶ç›‘æ§

æŸ¥çœ‹ CPUã€å†…å­˜ç­‰å®æ—¶æ•°æ®ï¼š

```bash
pm2 monit
```

æ˜¾ç¤ºç±»ä¼¼ï¼š

```
â”Œâ”€ Process List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€ EA&CTrader-Webhook Metrics â”€â”€â”€â”€â”€â”
â”‚                                â”‚â”‚ CPU Usage:      0.5%           â”‚
â”‚ [0] EA&CTrader-Webhook            â”‚â”‚ Memory Usage:   31.2 MB        â”‚
â”‚ status: online                 â”‚â”‚ Restart:        0              â”‚
â”‚ cpu: 0%                        â”‚â”‚ Uptime:         2h 15m         â”‚
â”‚ memory: 30MB                   â”‚â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯

```bash
pm2 describe EA&CTrader-Webhook
```

æ˜¾ç¤ºï¼š
- è¿›ç¨‹ ID
- è¿è¡Œæ—¶é—´
- é‡å¯æ¬¡æ•°
- å†…å­˜ä½¿ç”¨
- æ—¥å¿—æ–‡ä»¶è·¯å¾„
- é…ç½®ä¿¡æ¯

---

### ç®¡ç†å¤šä¸ªæœåŠ¡

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡
pm2 list

# é‡å¯æ‰€æœ‰æœåŠ¡
pm2 restart all

# åœæ­¢æ‰€æœ‰æœåŠ¡
pm2 stop all

# åˆ é™¤æ‰€æœ‰æœåŠ¡
pm2 delete all
```

---

### è‡ªå®šä¹‰é…ç½®

ç¼–è¾‘ `pm2/ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'EA&CTrader-Webhook',
    script: './server.js',
    
    // ä¿®æ”¹å®ä¾‹æ•°é‡ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
    instances: 1,
    
    // è‡ªåŠ¨é‡å¯
    autorestart: true,
    
    // æœ€å¤§å†…å­˜é™åˆ¶
    max_memory_restart: '200M',  // æ”¹ä¸º '500M' æé«˜é™åˆ¶
    
    // æœ€å¤§é‡å¯æ¬¡æ•°
    max_restarts: 10,
    
    // æœ€å°è¿è¡Œæ—¶é—´
    min_uptime: '10s',
    
    // ç¯å¢ƒå˜é‡
    env: {
      NODE_ENV: 'production',
      PORT: 5000  // æ”¹ä¸ºå…¶ä»–ç«¯å£
    }
  }]
};
```

ä¿®æ”¹åé‡å¯ç”Ÿæ•ˆï¼š

```bash
pm2 restart EA&CTrader-Webhook
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
status: errored
```

**è§£å†³ï¼š**

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs EA&CTrader-Webhook --err

# å¸¸è§åŸå› ï¼š
# 1. ç«¯å£è¢«å ç”¨ â†’ ä¿®æ”¹ pm2/ecosystem.config.js ä¸­çš„ PORT
# 2. ä¾èµ–æœªå®‰è£… â†’ è¿è¡Œ npm install
# 3. é…ç½®é”™è¯¯ â†’ æ£€æŸ¥ server.js ä¸­çš„é…ç½®
```

---

### é—®é¢˜ 2ï¼šæœåŠ¡é¢‘ç¹é‡å¯

**ç—‡çŠ¶ï¼š**
```
â†º restart: 5
```

**è§£å†³ï¼š**

```bash
# æŸ¥çœ‹æ—¥å¿—æ‰¾å‡ºåŸå› 
pm2 logs EA&CTrader-Webhook --lines 100

# å¸¸è§åŸå› ï¼š
# 1. å†…å­˜ä¸è¶³ â†’ å¢åŠ  max_memory_restart
# 2. ä»£ç é”™è¯¯ â†’ æ£€æŸ¥ error.log
# 3. ä¾èµ–é—®é¢˜ â†’ npm install
```

---

### é—®é¢˜ 3ï¼šæ—¥å¿—æ–‡ä»¶å¤ªå¤§

**è§£å†³ï¼š**

```bash
# æ¸…ç©ºæ‰€æœ‰æ—¥å¿—
pm2 flush

# æˆ–è€…å®‰è£…æ—¥å¿—è½®è½¬æ¨¡å—
pm2 install pm2-logrotate

# é…ç½®æ—¥å¿—è½®è½¬
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

---

### é—®é¢˜ 4ï¼šPM2 å‘½ä»¤æ‰¾ä¸åˆ°

**ç—‡çŠ¶ï¼š**
```
'pm2' ä¸æ˜¯å†…éƒ¨æˆ–å¤–éƒ¨å‘½ä»¤
```

**è§£å†³ï¼š**

```bash
# é‡æ–°å®‰è£… PM2
npm install -g pm2

# æ£€æŸ¥ npm å…¨å±€è·¯å¾„
npm config get prefix

# Windows: ç¡®ä¿ä»¥ä¸‹è·¯å¾„åœ¨ç¯å¢ƒå˜é‡ PATH ä¸­
# C:\Users\ä½ çš„ç”¨æˆ·å\AppData\Roaming\npm
```

---

## ğŸ“ æ—¥å¸¸ä½¿ç”¨æµç¨‹

### å¼€å‘é˜¶æ®µ

1. **å¯åŠ¨æœåŠ¡ï¼š** åŒå‡» `pm2/PM2å¯åŠ¨.bat`
2. **æŸ¥çœ‹æ—¥å¿—ï¼š** åŒå‡» `PM2æŸ¥çœ‹æ—¥å¿—.bat`ï¼ˆè°ƒè¯•ç”¨ï¼‰
3. **ä¿®æ”¹ä»£ç åï¼š** åŒå‡» `PM2é‡å¯.bat`

### ç”Ÿäº§ç¯å¢ƒ

1. **é¦–æ¬¡éƒ¨ç½²ï¼š**
   ```bash
   npm install
   åŒå‡» pm2/PM2å¯åŠ¨.bat
   åŒå‡» PM2è®¾ç½®å¼€æœºå¯åŠ¨.bat
   ```

2. **æ›´æ–°ä»£ç åï¼š**
   ```bash
   åŒå‡» PM2é‡å¯.bat
   ```

3. **æ—¥å¸¸æ£€æŸ¥ï¼š**
   ```bash
   pm2 status  # æ£€æŸ¥è¿è¡ŒçŠ¶æ€
   pm2 logs    # æŸ¥çœ‹æ—¥å¿—
   ```

---

## ğŸ¯ å¯¹æ¯”ï¼šæ™®é€šå¯åŠ¨ vs PM2

| åŠŸèƒ½ | æ™®é€šå¯åŠ¨ (`npm start`) | PM2 (`pm2 start`) |
|------|----------------------|-------------------|
| éœ€è¦ç»ˆç«¯çª—å£ | âœ… æ˜¯ | âŒ å¦ |
| åå°è¿è¡Œ | âŒ å¦ | âœ… æ˜¯ |
| å´©æºƒè‡ªåŠ¨é‡å¯ | âŒ å¦ | âœ… æ˜¯ |
| å¼€æœºè‡ªå¯ | âŒ å¦ | âœ… æ˜¯ |
| æ—¥å¿—ç®¡ç† | âŒ å¦ | âœ… æ˜¯ |
| çŠ¶æ€ç›‘æ§ | âŒ å¦ | âœ… æ˜¯ |
| é€‚ç”¨åœºæ™¯ | å¼€å‘æµ‹è¯• | ç”Ÿäº§ä½¿ç”¨ |

---

## ğŸŒŸ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ PM2 å¯åŠ¨ï¼ˆæ¨èï¼‰

âœ… **ä¼˜ç‚¹ï¼š**
- ä¸å ç”¨ç»ˆç«¯çª—å£
- è‡ªåŠ¨é‡å¯ï¼Œç¨³å®šå¯é 
- ä¾¿äºç›‘æ§å’Œç®¡ç†

âŒ **ç¼ºç‚¹ï¼š**
- é¦–æ¬¡éœ€è¦å®‰è£… PM2

### 2. è®¾ç½®å¼€æœºè‡ªå¯

âœ… **é€‚ç”¨åœºæ™¯ï¼š**
- é•¿æœŸä½¿ç”¨
- æ— äººå€¼å®ˆ
- ç”Ÿäº§ç¯å¢ƒ

### 3. å®šæœŸæŸ¥çœ‹æ—¥å¿—

```bash
# æ¯å‘¨æ£€æŸ¥ä¸€æ¬¡
pm2 logs EA&CTrader-Webhook --lines 100

# æ¸…ç†æ—§æ—¥å¿—
pm2 flush
```

### 4. ç›‘æ§èµ„æºä½¿ç”¨

```bash
# å®šæœŸæŸ¥çœ‹
pm2 monit

# å¦‚æœå†…å­˜æŒç»­å¢é•¿ â†’ å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼
# è§£å†³ï¼šé‡å¯æœåŠ¡æˆ–å¢åŠ  max_memory_restart
```

---

## ğŸ“ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨

| æ“ä½œ | å‘½ä»¤ | å¿«æ·æ–¹å¼ |
|------|------|---------|
| å¯åŠ¨ | `pm2 start pm2/ecosystem.config.js` | `pm2/PM2å¯åŠ¨.bat` |
| åœæ­¢ | `pm2 stop EA&CTrader-Webhook` | `pm2/PM2åœæ­¢.bat` |
| é‡å¯ | `pm2 restart EA&CTrader-Webhook` | `pm2/PM2é‡å¯.bat` |
| åˆ é™¤ | `pm2 delete EA&CTrader-Webhook` | `pm2/PM2å®Œå…¨åˆ é™¤.bat` |
| çŠ¶æ€ | `pm2 status` | `pm2/PM2æŸ¥çœ‹çŠ¶æ€.bat` |
| æ—¥å¿— | `pm2 logs EA&CTrader-Webhook` | `pm2/PM2æŸ¥çœ‹æ—¥å¿—.bat` |
| ç›‘æ§ | `pm2 monit` | - |
| è¯¦æƒ… | `pm2 describe EA&CTrader-Webhook` | - |
| å¼€æœºå¯åŠ¨ | `pm2 startup && pm2 save` | `pm2/PM2è®¾ç½®å¼€æœºå¯åŠ¨.bat` |

---

## ğŸ‰ æ€»ç»“

ä½¿ç”¨ PM2 åï¼Œä½ å¯ä»¥ï¼š

1. âœ… **å…³é—­ç»ˆç«¯çª—å£** - æœåŠ¡ç»§ç»­è¿è¡Œ
2. âœ… **åå°è¿è¡Œ** - ä¸å½±å“å…¶ä»–æ“ä½œ
3. âœ… **è‡ªåŠ¨é‡å¯** - å´©æºƒåè‡ªåŠ¨æ¢å¤
4. âœ… **å¼€æœºè‡ªå¯** - ç”µè„‘é‡å¯åè‡ªåŠ¨è¿è¡Œ
5. âœ… **ä¾¿äºç®¡ç†** - ä¸€é”®å¯åœã€æŸ¥çœ‹æ—¥å¿—

**æ¨èåšæ³•ï¼š**
1. é¦–æ¬¡ä½¿ç”¨ï¼šåŒå‡» `pm2/PM2å¯åŠ¨.bat`
2. è®¾ç½®å¼€æœºå¯åŠ¨ï¼šåŒå‡» `PM2è®¾ç½®å¼€æœºå¯åŠ¨.bat`
3. ä»¥åå¿˜æ‰å®ƒï¼ŒæœåŠ¡ä¼šè‡ªåŠ¨è¿è¡Œï¼

---

**ç‰ˆæœ¬ï¼š** 1.0.0  
**æ›´æ–°æ—¥æœŸï¼š** 2025-11-24  
**ä½œè€…ï¼š** Keltner Signal Team

